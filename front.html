<!DOCTYPE html> 
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>किसान मित्र - Crop Predictor | कृषि सलाहकार</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  
  body{
    font-family:'Segoe UI',system-ui,Arial;
    background:linear-gradient(135deg,#0f172a 0%,#1e293b 25%,#334155 50%,#475569 100%);
    min-height:100vh;
    padding:20px;
    position:relative;
    overflow-x:hidden;
  }
  
  /* Animated background particles */
  body::before {
    content:'';
    position:fixed;
    top:0;left:0;right:0;bottom:0;
    background-image:radial-gradient(circle at 20% 80%, rgba(120,119,198,0.3) 0%, transparent 50%),
                     radial-gradient(circle at 80% 20%, rgba(255,119,198,0.3) 0%, transparent 50%),
                     radial-gradient(circle at 40% 40%, rgba(120,200,255,0.2) 0%, transparent 50%);
    pointer-events:none;
    z-index:-1;
    animation:particleFloat 20s ease-in-out infinite;
  }
  
  @keyframes particleFloat {
    0%, 100% { transform:translateY(0px) rotate(0deg); }
    33% { transform:translateY(-20px) rotate(1deg); }
    66% { transform:translateY(10px) rotate(-1deg); }
  }
  
  .container{max-width:1200px;margin:0 auto;position:relative;z-index:1}
  
  .header{
    text-align:center;
    position:relative;
    margin-bottom:30px;
    padding:20px;
    background:rgba(255,255,255,0.1);
    backdrop-filter:blur(20px);
    border-radius:20px;
    border:1px solid rgba(255,255,255,0.2);
    box-shadow:0 8px 32px rgba(0,0,0,0.1);
  }
  
  .status-pill{
    position:absolute;
    left:20px;top:20px;
    padding:10px 16px;
    border-radius:999px;
    background:rgba(16,185,129,0.2);
    backdrop-filter:blur(10px);
    display:flex;gap:8px;align-items:center;
    font-weight:700;color:#10b981;
    border:1px solid rgba(16,185,129,0.3);
    transition:all 0.3s ease;
  }
  
  .status-pill:hover { transform:scale(1.05); }
  
  .status-dot{
    width:10px;height:10px;border-radius:50%;
    animation:pulse 2s infinite;
  }
  .status-online{background:#10b981;box-shadow:0 0 10px rgba(16,185,129,0.5)}
  .status-offline{background:#ef4444;box-shadow:0 0 10px rgba(239,68,68,0.5)}
  
  @keyframes pulse {
    0% { box-shadow:0 0 0 0 rgba(16,185,129,0.7); }
    70% { box-shadow:0 0 0 10px rgba(16,185,129,0); }
    100% { box-shadow:0 0 0 0 rgba(16,185,129,0); }
  }
  
  .language-toggle{
    position:absolute;right:20px;top:20px;
    background:rgba(255,255,255,0.1);
    backdrop-filter:blur(10px);
    padding:10px 16px;border-radius:999px;
    cursor:pointer;display:flex;align-items:center;gap:8px;
    color:#ffffff;font-weight:600;
    border:1px solid rgba(255,255,255,0.2);
    transition:all 0.3s ease;
  }
  
  .language-toggle:hover {
    background:rgba(255,255,255,0.2);
    transform:translateY(-2px);
  }
  
  h1{
    font-size:2.5rem;margin-bottom:10px;
    background:linear-gradient(135deg,#ffffff 0%,#e2e8f0 100%);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
    text-shadow:0 2px 4px rgba(0,0,0,0.1);
  }
  
  p#subtitle{
    color:#cbd5e1;
    font-size:1.1rem;
    opacity:0.9;
  }

  .main-card{
    background:rgba(255,255,255,0.95);
    backdrop-filter:blur(20px);
    border-radius:24px;
    overflow:hidden;
    display:grid;
    grid-template-columns:450px 1fr;
    min-height:600px;
    box-shadow:0 25px 50px rgba(0,0,0,0.15);
    border:1px solid rgba(255,255,255,0.2);
    position:relative;
    animation:cardSlideIn 0.8s ease-out;
  }
  
  @keyframes cardSlideIn {
    0% { opacity:0; transform:translateY(20px); }
    100% { opacity:1; transform:translateY(0); }
  }
  
  .input-section{
    padding:32px;
    background:linear-gradient(180deg,rgba(248,251,255,0.9),rgba(243,247,255,0.9));
    backdrop-filter:blur(10px);
    border-right:1px solid rgba(15,23,42,0.1);
    position:relative;
  }
  
  .input-section::before {
    content:'';
    position:absolute;
    top:0;left:0;right:0;bottom:0;
    background:linear-gradient(135deg,transparent 0%,rgba(120,119,198,0.05) 100%);
    pointer-events:none;
  }
  
  .output-section{
    padding:32px;
    background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,251,246,0.9));
    backdrop-filter:blur(10px);
    display:flex;flex-direction:column;gap:20px;
  }
  
  .form-group{margin-bottom:16px;position:relative}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  
  label{
    display:block;font-weight:700;margin-bottom:8px;
    color:#1e293b;font-size:0.95rem;
    transition:color 0.3s ease;
  }
  
  .form-control{
    width:100%;padding:12px 16px;border-radius:12px;
    border:2px solid #e2e8f0;font-size:1rem;
    background:#ffffff;color:#1e293b;
    transition:all 0.3s ease;
    position:relative;
  }
  
  .form-control:focus{
    outline:none;
    border-color:#3b82f6;
    box-shadow:0 0 0 3px rgba(59,130,246,0.1);
    transform:translateY(-1px);
  }
  
  .form-control:hover{
    border-color:#cbd5e1;
  }
  
  .form-control[readonly]{
    background:linear-gradient(135deg,#f8fafc,#f1f5f9);
    color:#475569;
    border-color:#e2e8f0;
  }
  
  .predict-btn{
    width:100%;padding:16px;border-radius:16px;border:none;
    background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);
    color:#ffffff;font-weight:800;cursor:pointer;
    font-size:1.1rem;
    box-shadow:0 10px 25px rgba(59,130,246,0.3);
    transition:all 0.3s ease;
    position:relative;
    overflow:hidden;
  }
  
  .predict-btn::before {
    content:'';
    position:absolute;
    top:0;left:-100%;width:100%;height:100%;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);
    transition:left 0.5s;
  }
  
  .predict-btn:hover {
    transform:translateY(-2px);
    box-shadow:0 15px 35px rgba(59,130,246,0.4);
  }
  
  .predict-btn:hover::before {
    left:100%;
  }
  
  .predict-btn[disabled]{
    opacity:0.7;cursor:progress;
    transform:none;
  }
  
  .result-card{
    background:linear-gradient(135deg,#ffffff 0%,#f8fafc 100%);
    border-radius:16px;padding:24px;
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
    border:1px solid rgba(226,232,240,0.8);
    position:relative;
    overflow:hidden;
    animation:resultFadeIn 0.6s ease-out;
  }
  
  @keyframes resultFadeIn {
    0% { opacity:0; transform:scale(0.95); }
    100% { opacity:1; transform:scale(1); }
  }
  
  .result-card::before {
    content:'';
    position:absolute;
    top:0;left:0;right:0;height:4px;
    background:linear-gradient(90deg,#3b82f6,#10b981,#f59e0b);
  }
  
  .gauge-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:16px;
    margin-top:20px;
  }
  
  .gauge-box{
    background:linear-gradient(135deg,#ffffff 0%,#f8fafc 100%);
    border-radius:16px;padding:20px;
    display:flex;flex-direction:column;align-items:center;gap:8px;
    border:1px solid rgba(226,232,240,0.6);
    box-shadow:0 4px 12px rgba(0,0,0,0.05);
    transition:all 0.3s ease;
    position:relative;
    overflow:hidden;
  }
  
  .gauge-box:hover {
    transform:translateY(-4px);
    box-shadow:0 8px 20px rgba(0,0,0,0.12);
  }
  
  .gauge-box::before {
    content:'';
    position:absolute;
    top:0;left:0;right:0;bottom:0;
    background:linear-gradient(135deg,transparent 0%,rgba(59,130,246,0.02) 100%);
    pointer-events:none;
  }
  
  .gauge-label{
    font-size:1rem;font-weight:700;color:#1e293b;
    text-align:center;
  }
  
  .meter-svg{
    width:180px;height:90px;
    display:block;margin:10px 0;
  }
  
  .meter-label{
    font-weight:800;font-size:1rem;
    color:#1e293b;text-align:center;
  }
  
  .meter-value{
    color:#3b82f6;font-weight:900;
  }
  
  .small-muted{font-size:0.85rem;color:#64748b}
  .emoji-large{font-size:28px;margin-right:12px}

  .result-head{
    display:flex;justify-content:space-between;align-items:flex-start;
    gap:16px;margin-bottom:16px;
  }
  
  .result-left{display:flex;gap:16px;align-items:center}
  .crop-title{font-size:1.5rem;font-weight:800;color:#1e293b}
  .prob-value{font-size:1.2rem;font-weight:900;color:#3b82f6}

  .weather-card{
    background:linear-gradient(135deg,rgba(255,255,255,0.9) 0%,rgba(241,249,255,0.9) 100%);
    backdrop-filter:blur(10px);
    border:1px solid rgba(226,232,240,0.8);
    border-radius:16px;padding:20px;
    box-shadow:0 8px 20px rgba(0,0,0,0.08);
    transition:all 0.3s ease;
  }
  
  .weather-card:hover {
    transform:translateY(-2px);
    box-shadow:0 12px 30px rgba(0,0,0,0.12);
  }

  /* Spinning loader */
  .spinner{
    border:3px solid rgba(255,255,255,0.3);
    border-top:3px solid #ffffff;
    border-radius:50%;width:20px;height:20px;
    animation:spin 1s linear infinite;
  }
  
  @keyframes spin{
    0%{transform:rotate(0deg)}
    100%{transform:rotate(360deg)}
  }

  /* Responsive design */
  @media(max-width:1024px){
    .main-card{
      grid-template-columns:1fr;
      max-width:600px;
      margin:0 auto;
    }
    .input-section{order:2;border-right:none;border-top:1px solid rgba(15,23,42,0.1)}
    .output-section{order:1}
    h1{font-size:2rem}
    .gauge-grid{grid-template-columns:repeat(2,1fr)}
  }
  
  @media(max-width:640px){
    body{padding:10px}
    .header{padding:15px;margin-bottom:20px}
    .status-pill,.language-toggle{position:static;margin:5px}
    .input-section,.output-section{padding:20px}
    .gauge-grid{grid-template-columns:1fr}
    .form-row{grid-template-columns:1fr;gap:12px}
    h1{font-size:1.5rem}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div id="backendStatusPill" class="status-pill" title="Backend connection status">
        <span id="backendDot" class="status-dot status-offline"></span>
        <span id="backendText">Backend: Offline</span>
      </div>

      <div class="language-toggle" id="languageToggle" role="button" tabindex="0">
        <i class="fas fa-language"></i> <span id="langText">हिंदी</span>
      </div>
      
      <h1><i class="fas fa-seedling"></i> <span id="mainTitle">किसान मित्र - Crop Predictor</span></h1>
      <p id="subtitle">आपकी फसल की भविष्यवाणी करने वाला स्मार्ट सलाहकार</p>
    </div>

    <div class="main-card">
      <!-- Input Section -->
      <div class="input-section">
        <h3 style="margin-bottom:20px;color:#1e293b;font-size:1.2rem">
          <i class="fas fa-edit" style="color:#3b82f6"></i> 
          <span id="formTitle">फसल की जानकारी दें</span>
        </h3>

        <form id="cropForm" autocomplete="off">
          <div class="form-group">
            <label id="soilLabel">मिट्टी का प्रकार</label>
            <select id="soil" class="form-control" required>
              <option value="" id="soilPlaceholder" disabled selected>मिट्टी चुनें</option>
              <option value="alluvial">जलोढ़ मिट्टी | Alluvial</option>
              <option value="loamy">दोमट मिट्टी | Loamy</option>
              <option value="clay">चिकनी मिट्टी | Clay</option>
              <option value="well-drained">अच्छी जल निकासी | Well-drained</option>
              <option value="red">लाल मिट्टी | Red</option>
              <option value="black">काली मिट्टी | Black</option>
              <option value="sandy">रेतीली मिट्टी | Sandy</option>
            </select>
          </div>

          <div class="form-group">
            <label id="seasonLabel">बुवाई का मौसम</label>
            <select id="sown" class="form-control" required>
              <option value="" id="seasonPlaceholder" disabled selected>मौसम चुनें</option>
              <option value="kharif">खरीफ | Kharif</option>
              <option value="rabi">रबी | Rabi</option>
              <option value="zaid">जायद | Zaid</option>
            </select>
          </div>

          <div class="form-group">
            <label id="phLabel">मिट्टी का pH <span class="small-muted">(0.0 - 14.0)</span></label>
            <input id="soil_ph" class="form-control" type="number" step="0.1" min="0" max="14" placeholder="e.g. 7.0" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label id="tempLabel">तापमान <span class="small-muted">(°C)</span></label>
              <input id="temp" class="form-control" type="number" step="any" placeholder="—" readonly>
            </div>
            <div class="form-group">
              <label id="humidityLabel">आर्द्रता <span class="small-muted">(%)</span></label>
              <input id="humidity" class="form-control" type="number" step="any" placeholder="—" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label id="nitrogenLabel">नाइट्रोजन (N) <span class="small-muted">(kg/ha)</span></label>
              <input id="nitrogen" class="form-control" type="number" step="any" min="0" max="300" placeholder="e.g. 50">
            </div>
            <div class="form-group">
              <label id="phosphorusLabel">फास्फोरस (P) <span class="small-muted">(kg/ha)</span></label>
              <input id="phosphorus" class="form-control" type="number" step="any" min="0" max="150" placeholder="e.g. 25">
            </div>
          </div>

          <div class="form-group">
            <label id="potassiumLabel">पोटैशियम (K) <span class="small-muted">(kg/ha)</span></label>
            <input id="potassium" class="form-control" type="number" step="any" min="0" max="250" placeholder="e.g. 30">
          </div>

          <button class="predict-btn" id="predictBtnEl" type="submit">
            <i class="fas fa-magic"></i> <span id="predictBtn">फसल की भविष्यवाणी करें</span>
          </button>
        </form>

        <div style="margin-top:20px;display:flex;gap:12px;align-items:center">
          <button id="translateBrowserBtn" class="form-control" style="cursor:pointer;padding:10px;border-radius:12px;font-size:0.9rem">
            <i class="fas fa-globe"></i> <span id="translateBrowserText">Translate Page</span>
          </button>
        </div>
      </div>

      <!-- Output Section -->
      <div class="output-section">
        <div id="weatherCardPlaceholder" style="width:100%"></div>

        <div id="resultsContainer" style="width:100%">
          <div class="result-card" id="emptyState">
            <div style="text-align:center;padding:40px 20px">
              <i class="fas fa-seedling" style="font-size:48px;color:#cbd5e1;margin-bottom:16px"></i>
              <h3 style="color:#475569;margin-bottom:8px" id="emptyTitle">कृपया विवरण भरें</h3>
              <p class="small-muted" id="emptySubtitle">Please fill the details to get crop predictions</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* Configuration */
const API_BASE = "https://crop-sage-updated.onrender.com";

/* Language translations */
const translations = {
  hi: {
    mainTitle: "किसान मित्र - Crop Predictor",
    subtitle: "आपकी फसल की भविष्यवाणी करने वाला स्मार्ट सलाहकार",
    formTitle: "फसल की जानकारी दें",
    soilLabel: "मिट्टी का प्रकार",
    soilPlaceholder: "मिट्टी चुनें",
    seasonLabel: "बुवाई का मौसम",
    seasonPlaceholder: "मौसम चुनें",
    phLabel: "मिट्टी का pH",
    tempLabel: "तापमान",
    humidityLabel: "आर्द्रता",
    nitrogenLabel: "नाइट्रोजन (N)",
    phosphorusLabel: "फास्फोरस (P)",
    potassiumLabel: "पोटैशियम (K)",
    predictBtn: "फसल की भविष्यवाणी करें",
    emptyTitle: "कृपया विवरण भरें",
    emptySubtitle: "Please fill the details to get crop predictions",
    translateBrowserText: "Translate Page",
    langText: "हिंदी",
    backendConnected: "Backend: Connected",
    backendOffline: "Backend: Offline"
  },
  en: {
    mainTitle: "Kisan Mitra - Crop Predictor",
    subtitle: "Smart Agricultural Advisor for Crop Prediction",
    formTitle: "Enter Crop Information",
    soilLabel: "Soil Type",
    soilPlaceholder: "Select Soil Type",
    seasonLabel: "Sowing Season",
    seasonPlaceholder: "Select Season",
    phLabel: "Soil pH",
    tempLabel: "Temperature",
    humidityLabel: "Humidity",
    nitrogenLabel: "Nitrogen (N)",
    phosphorusLabel: "Phosphorus (P)",
    potassiumLabel: "Potassium (K)",
    predictBtn: "Predict Crop",
    emptyTitle: "Please Fill Details",
    emptySubtitle: "कृपया विवरण भरें - फसल की भविष्यवाणी के लिए",
    translateBrowserText: "पृष्ठ अनुवाद करें",
    langText: "English",
    backendConnected: "Backend: जुड़ा हुआ",
    backendOffline: "Backend: ऑफलाइन"
  }
};

let currentLang = 'hi';

function updateLanguage(lang) {
  currentLang = lang;
  const t = translations[lang];
  
  // Update main elements
  document.getElementById('mainTitle').textContent = t.mainTitle;
  document.getElementById('subtitle').textContent = t.subtitle;
  document.getElementById('formTitle').textContent = t.formTitle;
  document.getElementById('soilLabel').textContent = t.soilLabel;
  document.getElementById('soilPlaceholder').textContent = t.soilPlaceholder;
  document.getElementById('seasonLabel').textContent = t.seasonLabel;
  document.getElementById('seasonPlaceholder').textContent = t.seasonPlaceholder;
  document.getElementById('phLabel').innerHTML = ${t.phLabel} <span class="small-muted">(0.0 - 14.0)</span>;
  document.getElementById('tempLabel').innerHTML = ${t.tempLabel} <span class="small-muted">(°C)</span>;
  document.getElementById('humidityLabel').innerHTML = ${t.humidityLabel} <span class="small-muted">(%)</span>;
  document.getElementById('nitrogenLabel').innerHTML = ${t.nitrogenLabel} <span class="small-muted">(kg/ha)</span>;
  document.getElementById('phosphorusLabel').innerHTML = ${t.phosphorusLabel} <span class="small-muted">(kg/ha)</span>;
  document.getElementById('potassiumLabel').innerHTML = ${t.potassiumLabel} <span class="small-muted">(kg/ha)</span>;
  document.getElementById('predictBtn').textContent = t.predictBtn;
  document.getElementById('emptyTitle').textContent = t.emptyTitle;
  document.getElementById('emptySubtitle').textContent = t.emptySubtitle;
  document.getElementById('translateBrowserText').textContent = t.translateBrowserText;
  document.getElementById('langText').textContent = t.langText;
  
  // Update backend status
  const isOnline = backendOnline;
  document.getElementById('backendText').textContent = isOnline ? t.backendConnected : t.backendOffline;
  
  // Update HTML lang attribute
  document.documentElement.lang = lang;
}

/* Backend status logic */
let backendFailCount = 0;
let backendOnline = false;
const backendDot = document.getElementById('backendDot');
const backendText = document.getElementById('backendText');

function setBackendUI(isOnline){
  backendOnline = !!isOnline;
  const t = translations[currentLang];
  if(isOnline){
    backendDot.classList.remove('status-offline');
    backendDot.classList.add('status-online');
    backendText.textContent = t.backendConnected;
    backendText.style.color = '#10b981';
  } else {
    backendDot.classList.remove('status-online');
    backendDot.classList.add('status-offline');
    backendText.textContent = t.backendOffline;
    backendText.style.color = '#ef4444';
  }
}

async function checkBackend(){
  try {
    const controller = new AbortController();
    const id = setTimeout(()=>controller.abort(), 3500);
    const res = await fetch(${API_BASE}/health, {cache:'no-store', mode:'cors', signal: controller.signal});
    clearTimeout(id);
    if(res && res.ok){
      backendFailCount = 0;
      setBackendUI(true);
      return true;
    }
    throw new Error('health failed');
  } catch(err){
    backendFailCount++;
    if(backendFailCount >= 2) setBackendUI(false);
    console.warn('checkBackend:', err);
    return false;
  }
}

/* Weather helpers */
const weatherCardPlaceholder = document.getElementById('weatherCardPlaceholder');

async function fetchWeatherForCoords(lat, lon) {
  const url = https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&current_weather=true&hourly=relativehumidity_2m&timezone=auto;
  try {
    const r = await fetch(url);
    if(!r.ok) throw new Error('Weather API error ' + r.status);
    return await r.json();
  } catch(e){
    console.warn(e);
    return null;
  }
}

function pickLatestHourly(h){
  if(!h || !h.time || !h.relativehumidity_2m) return null;
  return Number(h.relativehumidity_2m[h.time.length-1]);
}

function renderWeatherCard(weatherData, coordsText){
  if(!weatherData || !weatherData.current_weather){
    weatherCardPlaceholder.innerHTML = `
      <div class="weather-card">
        <div style="color:#64748b;text-align:center">Weather information not available</div>
      </div>`;
    return;
  }
  
  const w = weatherData.current_weather;
  const temp = w.temperature;
  const humidityHourly = pickLatestHourly(weatherData.hourly);
  
  document.getElementById('temp').value = temp ?? '';
  document.getElementById('humidity').value = humidityHourly ?? '';

  const codeMap = {
    0:'Clear ☀', 1:'Mainly clear 🌤', 2:'Partly cloudy ⛅', 3:'Overcast ☁',
    45:'Fog 🌫', 48:'Rime fog ❄', 51:'Drizzle 🌦', 61:'Rain 🌧',
    80:'Showers 🌦', 95:'Thunderstorm ⛈'
  };
  const label = codeMap[w.weathercode] || 'Weather';

  weatherCardPlaceholder.innerHTML = `
    <div class="weather-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;gap:16px;align-items:center">
          <div style="font-size:1.2rem;font-weight:700;color:#1e293b">${label}</div>
          <div style="font-size:1rem;color:#475569">
            <strong>${temp}°C</strong> • ${humidityHourly ?? '—'}%
          </div>
        </div>
        <div style="text-align:right">
          <div class="small-muted">Source: Open-Meteo</div>
          <button id="refreshWeatherBtn" style="margin-top:8px;padding:8px 12px;border:1px solid #e2e8f0;background:#fff;border-radius:8px;cursor:pointer;color:#475569;font-size:0.85rem">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('refreshWeatherBtn').addEventListener('click', ()=> getWeatherFromBrowser(true));
}

function renderWeatherRequesting(){
  weatherCardPlaceholder.innerHTML = `
    <div class="weather-card">
      <div style="padding:20px;color:#64748b;text-align:center">
        <i class="fas fa-spinner fa-spin" style="margin-right:8px"></i>
        Fetching location & weather…
      </div>
    </div>`;
}

async function getWeatherFromBrowser(force=false){
  renderWeatherRequesting();
  if(!navigator.geolocation){
    weatherCardPlaceholder.innerHTML = `
      <div class="weather-card">
        <div style="padding:20px;color:#64748b;text-align:center">Geolocation not supported</div>
      </div>`;
    return;
  }
  
  const pos = await new Promise(resolve => 
    navigator.geolocation.getCurrentPosition(resolve, err => resolve({error:err}), {timeout:12000})
  );
  
  if(pos && pos.error){
    weatherCardPlaceholder.innerHTML = `
      <div class="weather-card">
        <div style="padding:20px;color:#64748b;text-align:center">Location permission denied or unavailable</div>
      </div>`;
    return;
  }
  
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  const coordsText = lat ${lat.toFixed(2)}, lon ${lon.toFixed(2)};
  const data = await fetchWeatherForCoords(lat, lon);
  renderWeatherCard(data, coordsText);
}

/* Utility functions */
function uniqueId(pref='id'){
  return pref + Math.random().toString(36).slice(2,9);
}

/* Meter coloring and rendering */
function colorForPercent(p, key){
  if(key === 'ph'){
    const pH = (p/100)*14;
    if(pH >= 6.0 && pH <= 8.0) return '#10b981'; // green (optimal)
    if(pH >= 5.5 && pH < 6.0) return '#f59e0b'; // yellow
    if(pH > 8.0 && pH <= 8.5) return '#f97316'; // orange  
    return '#ef4444'; // red (poor)
  } else {
    // For nutrients (N,P,K)
    if(p <= 25) return '#ef4444';      // red (very low)
    if(p <= 50) return '#f97316';      // orange (low)
    if(p <= 75) return '#f59e0b';      // yellow (medium)
    return '#10b981';                  // green (high)
  }
}

function percentToAngle(p){
  return -90 + (p/100)*180;
}

function semicircleMeter(percent, key, width=180, height=90){
  const id = uniqueId('meter');
  const cx = width/2;
  const cy = height;
  const r = Math.min(width/2 - 20, height - 20);
  
  // Create background arc path
  const startAngle = Math.PI; // 180 degrees
  const endAngle = 0;         // 0 degrees
  const startX = cx + r * Math.cos(startAngle);
  const startY = cy + r * Math.sin(startAngle);
  const endX = cx + r * Math.cos(endAngle);
  const endY = cy + r * Math.sin(endAngle);
  const arcPath = M ${startX} ${startY} A ${r} ${r} 0 0 1 ${endX} ${endY};

  // Calculate dash properties for progress
  const circumference = Math.PI * r; // Half circle
  const dashLength = circumference;
  const dashOffset = circumference * (1 - (percent/100));

  // Get appropriate color
  const fillColor = colorForPercent(percent, key);

  // Create tick marks
  const ticks = [0, 25, 50, 75, 100].map(tickPercent => {
    const angle = percentToAngle(tickPercent) * Math.PI/180;
    const x1 = cx + (r-5) * Math.cos(angle);
    const y1 = cy + (r-5) * Math.sin(angle);
    const x2 = cx + (r+5) * Math.cos(angle);
    const y2 = cy + (r+5) * Math.sin(angle);
    return <line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#e2e8f0" stroke-width="2"/>;
  }).join('');

  return `
    <svg width="${width}" height="${height}" class="meter-svg">
      <!-- Background arc -->
      <path d="${arcPath}" fill="none" stroke="#f1f5f9" stroke-width="8" stroke-linecap="round"/>
      
      <!-- Tick marks -->
      ${ticks}
      
      <!-- Progress arc -->
      <path d="${arcPath}" fill="none" stroke="${fillColor}" stroke-width="8" 
            stroke-linecap="round" stroke-dasharray="${dashLength}" 
            stroke-dashoffset="${dashOffset}" opacity="0.9"/>
      
      <!-- Center text -->
      <text x="${cx}" y="${cy-10}" text-anchor="middle" fill="#1e293b" font-weight="700" font-size="18">
        ${percent.toFixed(0)}%
      </text>
    </svg>
  `;
}

/* Crop prediction logic */
async function predictCrop(formData) {
  try {
    const response = await fetch(${API_BASE}/predict, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(formData)
    });

    if (!response.ok) {
      throw new Error(HTTP ${response.status}: ${response.statusText});
    }

    return await response.json();
  } catch (error) {
    console.error('Prediction error:', error);
    throw error;
  }
}

/* Local fallback predictor (runs when backend unavailable or request fails)
   - Uses simple heuristic rules and normalizes nutrient values to percentages.
   - Keeps output shape compatible with backend: { predicted_crop, confidence, nutrient_analysis }
*/
async function localPredict(formData) {
  // Heuristic selection
  const soil = (formData.soil_type || '').toLowerCase();
  const season = (formData.season || '').toLowerCase();
  const pH = Number(formData.pH || 7.0);
  const temp = Number(formData.temperature || 25);
  const humidity = Number(formData.humidity || 50);
  const nitrogen = Number(formData.nitrogen || 50);
  const phosphorus = Number(formData.phosphorus || 25);
  const potassium = Number(formData.potassium || 30);

  // Basic rules for crop choice
  let crop = 'wheat';
  if (season === 'kharif') {
    if ((soil.includes('alluvial') || soil.includes('well') || soil.includes('loamy')) && humidity >= 60) crop = 'rice';
    else if (soil.includes('sandy')) crop = 'maize';
    else crop = 'rice';
  } else if (season === 'rabi') {
    if (soil.includes('loamy') || soil.includes('black') || soil.includes('alluvial')) crop = 'wheat';
    else crop = 'wheat';
  } else if (season === 'zaid') {
    if (soil.includes('sandy') || temp >= 28) crop = 'maize';
    else crop = 'cotton';
  } else {
    // fallback heuristics using humidity and temp
    if (humidity > 70) crop = 'rice';
    else if (temp > 28) crop = 'maize';
    else crop = 'wheat';
  }

  // Confidence calculation (simple scoring)
  let score = 50;
  // better pH (6-8) gives boost
  if (pH >= 6 && pH <= 8) score += 15;
  // humidity good for rice if high
  if (crop === 'rice' && humidity >= 60) score += 10;
  // temperature aligned
  if ((crop === 'maize' && temp >= 24) || (crop === 'wheat' && temp >= 10 && temp <= 25)) score += 10;
  // soil match
  if ((crop === 'rice' && (soil.includes('alluvial') || soil.includes('well'))) ||
      (crop === 'wheat' && (soil.includes('loamy') || soil.includes('black'))) ||
      (crop === 'maize' && soil.includes('sandy'))) {
    score += 10;
  }

  // clamp
  const confidence = Math.min(95, Math.max(40, score));

  // Normalize nutrients to percentages for the meter display
  // Use reasonable maxima for normalization (arbitrary but sensible)
  const nPercent = Math.min(100, (nitrogen / 150) * 100);   // 150 kg/ha considered high
  const pPercent = Math.min(100, (phosphorus / 100) * 100); // 100 kg/ha considered high
  const kPercent = Math.min(100, (potassium / 200) * 100);  // 200 kg/ha considered high
  const phPercent = Math.min(100, Math.max(0, (pH / 14) * 100));

  return {
    predicted_crop: crop,
    confidence: Number(confidence.toFixed(1)),
    nutrient_analysis: {
      nitrogen: Number(nPercent.toFixed(1)),
      phosphorus: Number(pPercent.toFixed(1)),
      potassium: Number(kPercent.toFixed(1)),
      ph: Number(phPercent.toFixed(1))
    },
    // small note used internally (not displayed) to indicate fallback origin
    _local_predictor: true
  };
}

function getCropEmoji(cropName) {
  const emojiMap = {
    'rice': '🌾', 'wheat': '🌾', 'maize': '🌽', 'cotton': '🌱',
    'sugarcane': '🎋', 'groundnut': '🥜', 'soybean': '🌱', 'onion': '🧅',
    'potato': '🥔', 'tomato': '🍅', 'cabbage': '🥬', 'peas': '🟢',
    'chickpea': '🌱', 'lentil': '🌱', 'blackgram': '⚫', 'mungbean': '🟢',
    'kidneybeans': '🫘', 'pigeonpeas': '🌱', 'mothbeans': '🌱', 'mango': '🥭',
    'grapes': '🍇', 'apple': '🍎', 'banana': '🍌', 'papaya': '🥭',
    'coconut': '🥥', 'watermelon': '🍉', 'muskmelon': '🍈', 'orange': '🍊'
  };
  
  return emojiMap[cropName?.toLowerCase()] || '🌱';
}

function renderResults(results) {
  const resultsContainer = document.getElementById('resultsContainer');
  const crop = results.predicted_crop;
  const confidence = results.confidence || 0;
  const nutrients = results.nutrient_analysis || {};
  
  const emoji = getCropEmoji(crop);
  
  // Create nutrient gauges
  const gauges = ['nitrogen', 'phosphorus', 'potassium', 'ph'].map(nutrient => {
    const value = nutrients[nutrient] || 0;
    const displayName = {
      nitrogen: currentLang === 'hi' ? 'नाइट्रोजन' : 'Nitrogen',
      phosphorus: currentLang === 'hi' ? 'फास्फोरस' : 'Phosphorus', 
      potassium: currentLang === 'hi' ? 'पोटैशियम' : 'Potassium',
      ph: currentLang === 'hi' ? 'pH स्तर' : 'pH Level'
    }[nutrient];
    
    return `
      <div class="gauge-box">
        <div class="gauge-label">${displayName}</div>
        ${semicircleMeter(value, nutrient)}
        <div class="meter-label">
          <span class="meter-value">${value.toFixed(1)}${nutrient === 'ph' ? '' : '%'}</span>
        </div>
      </div>
    `;
  }).join('');

  const cropDisplayName = currentLang === 'hi' ? 
    (crop === 'rice' ? 'चावल' : 
     crop === 'wheat' ? 'गेहूं' : 
     crop === 'maize' ? 'मक्का' : 
     crop === 'cotton' ? 'कपास' : 
     crop) : crop;

  resultsContainer.innerHTML = `
    <div class="result-card">
      <div class="result-head">
        <div class="result-left">
          <span class="emoji-large">${emoji}</span>
          <div>
            <div class="crop-title">${cropDisplayName}</div>
            <div class="small-muted">${currentLang === 'hi' ? 'सुझाई गई फसल' : 'Recommended Crop'}</div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="prob-value">${confidence.toFixed(1)}%</div>
          <div class="small-muted">${currentLang === 'hi' ? 'विश्वसनीयता' : 'Confidence'}</div>
        </div>
      </div>
      
      <div class="gauge-grid">
        ${gauges}
      </div>
      
      <div style="margin-top:20px;padding:16px;background:rgba(59,130,246,0.05);border-radius:12px;border-left:4px solid #3b82f6">
        <div style="font-weight:700;color:#1e293b;margin-bottom:8px">
          ${currentLang === 'hi' ? '📋 सुझाव:' : '📋 Recommendations:'}
        </div>
        <p style="color:#475569;font-size:0.9rem;line-height:1.5">
          ${currentLang === 'hi' ? 
            मिट्टी और मौसम की स्थिति के आधार पर ${cropDisplayName} की खेती की सिफारिश की जाती है। उर्वरक के स्तर की जांच करें और आवश्यकतानुसार समायोजन करें। :
            Based on soil and weather conditions, ${crop} cultivation is recommended. Monitor nutrient levels and adjust fertilizers as needed.}
        </p>
      </div>
    </div>
  `;
}

/* Form handling */
document.getElementById('cropForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const predictBtn = document.getElementById('predictBtnEl');
  const originalText = predictBtn.innerHTML;
  
  // Show loading state
  predictBtn.disabled = true;
  predictBtn.innerHTML = <div class="spinner"></div> ${currentLang === 'hi' ? 'भविष्यवाणी हो रही है...' : 'Predicting...'};
  
  try {
    // Check backend connectivity
    const isOnline = await checkBackend();
    
    // Collect form data
    const formData = {
      soil_type: document.getElementById('soil').value,
      season: document.getElementById('sown').value,
      pH: parseFloat(document.getElementById('soil_ph').value),
      temperature: parseFloat(document.getElementById('temp').value) || null,
      humidity: parseFloat(document.getElementById('humidity').value) || null,
      nitrogen: parseFloat(document.getElementById('nitrogen').value) || 50,
      phosphorus: parseFloat(document.getElementById('phosphorus').value) || 25,
      potassium: parseFloat(document.getElementById('potassium').value) || 30
    };
    
    let results;
    if (isOnline) {
      // Try backend predict, but fallback to local if request fails
      try {
        results = await predictCrop(formData);
      } catch (err) {
        console.warn('Backend predict failed, using local predictor. Error:', err);
        results = await localPredict(formData);
        // mark backend offline UI (it may have been flaky)
        setBackendUI(false);
      }
    } else {
      // Backend not available -> use local prediction
      results = await localPredict(formData);
    }
    
    renderResults(results);
    
  } catch (error) {
    console.error('Prediction failed:', error);
    document.getElementById('resultsContainer').innerHTML = `
      <div class="result-card">
        <div style="text-align:center;padding:40px 20px">
          <i class="fas fa-exclamation-triangle" style="font-size:48px;color:#ef4444;margin-bottom:16px"></i>
          <h3 style="color:#ef4444;margin-bottom:8px">${currentLang === 'hi' ? 'त्रुटि हुई' : 'Error Occurred'}</h3>
          <p class="small-muted">${error.message}</p>
        </div>
      </div>
    `;
  } finally {
    predictBtn.disabled = false;
    predictBtn.innerHTML = originalText;
  }
});

/* Language toggle */
document.getElementById('languageToggle').addEventListener('click', function() {
  const newLang = currentLang === 'hi' ? 'en' : 'hi';
  updateLanguage(newLang);
});

/* Browser translate button */
document.getElementById('translateBrowserBtn').addEventListener('click', function() {
  // Use Google Translate widget or browser's built-in translate
  if (window.google && window.google.translate) {
    // If Google Translate is available
    window.google.translate.TranslateElement();
  } else {
    // Fallback: prompt user to use browser's translate feature
    alert(currentLang === 'hi' ? 
      'कृपया अपने ब्राउज़र के अनुवाद सुविधा का उपयोग करें (राइट-क्लिक → अनुवाद)' :
      'Please use your browser\'s built-in translate feature (right-click → translate)'
    );
  }
});

/* Initialize app */
document.addEventListener('DOMContentLoaded', function() {
  // Check backend status on load
  checkBackend();
  
  // Get weather data
  getWeatherFromBrowser();
  
  // Set up periodic backend checks
  setInterval(checkBackend, 30000); // Check every 30 seconds
  
  // Initialize with Hindi
  updateLanguage('hi');
});

/* Keyboard navigation for language toggle */
document.getElementById('languageToggle').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    this.click();
  }
});
</script>
</body>
</html>
